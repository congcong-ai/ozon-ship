# Ozon 最优售价——数学模型与求解方法

本文定义在 Ozon 平台上，给定商品重量/尺寸/进货价与费用参数、可选物流与资费档（如 Ural 的 Express/Standard/Economy），如何计算“最优售价（或最优区间）”，避免跨组导致运费跳变而亏损。

---

## 1. 符号与单位
- 货币：
  - RUB = 俄罗斯卢布；CNY = 人民币
  - 记汇率 `R = RUB/CNY`（1 人民币可兑换的卢布数）。
- 变量：
  - `w`：重量（g）
  - `d = (l, w, h)`：尺寸（cm）
  - `c_cny`：进货成本（CNY）
  - `P`：商品在 Ozon 的标价（RUB）
  - `g(P, w)`：Ozon 六个组的映射函数，给定标价和重量，返回所属组（见第 2 节）
  - `L_{carrier,tier,group}(w)`：国际物流成本函数（CNY），由所选“物流商/档位/组”与重量决定
  - `H(P)`：尾城配送费（RUB），默认 2%，但有 Min/Max 约束
  - 费率：
    - 平台佣金 `α`（默认 12%）
    - 银行收单费 `β`（默认 1.9%，可设 0.4%~1.9%）
    - 货币转换费 `γ`（默认 1.2%，按平台回款计提）

> 若“物流商/档位”留空，则在所有可用组合上求最大值。

---

## 2. Ozon 六组（Price × Weight）
设 `P` 为标价（RUB），`w` 为重量（g），六组定义如下（来自官方示意图）：

- Extra Small：`P ≤ 1500` 且 `1 ≤ w ≤ 500`
- Budget：`P ≤ 1500` 且 `501 ≤ w ≤ 30000`
- Small：`1501 ≤ P ≤ 7000` 且 `1 ≤ w ≤ 2000`
- Big：`1501 ≤ P ≤ 7000` 且 `2001 ≤ w ≤ 30000`
- Premium Small：`7001 ≤ P ≤ 250000` 且 `1 ≤ w ≤ 5000`
- Premium Big：`7001 ≤ P ≤ 250000` 且 `5001 ≤ w ≤ 30000`

因此，当 `w` 固定时，允许的 `P` 区间由上表限定；跨越 1500/7000 两个价格边界会切换组，从而引发国际运费的阶跃变化。

---

## 3. 物流成本函数（示例：Ural）
Ural 的每个档位（Express/Standard/Economy）下，针对六个组分别给出“基础费 + 克费”的线性模型：

```
L_{carrier,tier,group}(w) = base_cny + rate_cny_per_g × w
```

注意：
- Ural 在“到取货点配送”“上门配送”之间的价格不同，建议作为一个可选输入 `delivery = pickup|door`；若未选择则取更优者。
- 其他物流商以相同的数据结构建模，便于统一计算与横向比较。

---

## 4. 尾城配送费与货币转换费
- 尾城配送费（RUB）：
  - `H(P) = clamp(η × P, H_min, H_max)`，默认 `η = 2%`，`H_min = 15`，`H_max = 200`。
  - 发生拐点的两个关键价格：`P = H_min/η = 750` 与 `P = H_max/η = 10000`。
- 货币转换费（RUB）：按“平台回款（不含转换费）”计提 `γ`。

---

## 5. 平台回款与利润公式
以 RUB 为主计量。

1) 平台扣费与物流费用：
```
commission(P) = α × P
acquiring(P)  = β × P
intl_logistics(P, w) = L_{…}(w) × R   // CNY → RUB
last_mile(P)  = H(P)
base_payout(P, w) = P - commission - acquiring - intl_logistics - last_mile
```

2) 货币转换费与最终回款：
```
fx_fee(P, w)   = γ × base_payout(P, w)
receipt_rub(P, w) = base_payout(P, w) - fx_fee
                 = (1 - γ) × base_payout(P, w)
```

3) 利润（CNY）与利润率：
```
profit_cny(P, w) = receipt_rub(P, w) / R - c_cny
margin(P, w)     = profit_cny / c_cny
```

> 若需要把国际物流费排除在“平台回款的计提基数”之外，亦可通过参数开关调整：
> 将 `fx_fee = γ × (P - commission - acquiring - last_mile)`；文档默认包含国际物流费。

---

## 6. 关键结论：最优解出现在“临界价格”附近
在任意一个固定组内：
- `intl_logistics` 对 `P` 为常数（仅依赖 `w` 与所选组）
- `last_mile(P)` 在 `P∈[0, 750]` 为常数（=15），`[750, 10000]` 为线性（2%），`≥10000` 为常数（=200）
- 其余费用对 `P` 线性

因此，`profit_cny(P)` 在“同一组 + 尾城费处于同一段”时是线性函数，其最优点必然位于该段的端点。

所有可能的最优点，均来自以下“临界价格集合”：
```
C = { 1499, 1500, 1501, 6999, 7000, 7001, 750, 10000 }
```
再加上：
- 每个允许区间的上下界（由第 2 节的组与当前重量决定）
- 商家自定义的上下限（如不高于竞品价、不低于目标利润价）

在实际实现中，我们只需在所有“候选价格点”上逐一代入，取使 `profit_cny` 或 `margin` 最大者；并给出“安全缓冲区间”，例如：`[1490, 1499]`、`[6985, 6999]`，以降低因四舍五入/汇率波动导致的跨组风险。

---

## 7. 求解算法（可直接编码）
输入：`w, d, c_cny, (α, β, γ), (η, H_min, H_max), R`，以及可选 `carrier, tier, delivery`。

步骤：
1. 根据 `w` 生成可行的组及其价格区间：
   - 若 `w ≤ 500`：Extra Small / Small / Premium Small
   - `501 ≤ w ≤ 2000`：Budget / Small / Premium Small
   - `2001 ≤ w ≤ 5000`：Budget / Big / Premium Small
   - `5001 ≤ w ≤ 30000`：Budget / Big / Premium Big
2. 对每个组，读取相应的 `L_{…}(w)`（若未指定物流商/档位，则对所有候选取“最佳”）。
3. 在该组的价格区间内，构造候选价格点：
   - 与 `{1500, 7000}` 相关的边界点（含“±1 RUB”）
   - 与尾城费拐点相关的 `{750, 10000}` 与区间端点
   - 用户自定义上下限、最小步长（1 RUB）
4. 对每个候选价 `P`，计算 `receipt_rub(P)`、`profit_cny(P)`、`margin(P)`。
5. 选出全局最大（或 Top-N），并输出：
   - 推荐价 `P*` 与“安全区间” `[P* - δ, P*]`（默认 `δ=5~20` RUB）
   - 对应组/物流商/档位/配送方式
   - 费用明细与利润率

复杂度：候选价个数常数级（每组 < 10 个），物流商/档位个数通常 < 10，总体 O(几十) 级，实时交互无压力。

---

## 8. 示例（与 CSV 一致的字段）
以“袜子（100g）”为例，仅演示计算流程（数值以 Ural-Standard/到点配送为示例，费率以截图为参考，非最终数据）：

1) 组的可行性：`w=100g` → 可能是 Extra Small（≤1500）、Small（1501~7000）、Premium Small（≥7001）。
2) 取 Ural-Standard 费率：
   - XS：`2.8 + 0.032×w` CNY
   - Small：`16 + 0.035×w` CNY
   - Premium Small：`22 + 0.035×w` CNY
3) 对每个组在候选点 {1499,1501,6999,7001,750,10000} 代入（再裁剪到该组区间），逐个计算 `profit_cny / margin`；
4) 返回最大者与备选第二、第三名，以便对比。

> 实际系统将基于你维护的 JSON 费率与实时汇率来给出精确结果，并在页面回显 E~I 列缺失的每一项。

---

## 9. 可配置项（前端可编辑）
- 费率：`α, β, γ, η, H_min, H_max`
- 汇率：`R`（默认实时，可手动改写）
- 价格边界缓冲：`ε_price = 1 RUB`，安全区间 `δ=5~20 RUB`
- 是否把国际物流费计入“平台回款”的计提基数
- 价格上/下限、目标利润率、竞品参考价

---

## 10. 输出要求（用于 UI）
- 单一推荐：`P*`、对应组、物流组合、利润率、各费用项（E~I）与最终回款
- Top-N 方案：按利润率排序
- 曲线与解释：以“价格-利润率”折线在阈值附近可视化，标注 1500/7000/750/10000 四条关键竖线

---

## 11. 为什么不是“简单公式一次求出 P*”？
因为国际运费与组别（受价格与重量共同约束）之间是分段常数+阶跃关系，`profit(P)` 属于“分段线性 + 阶跃”。其全局最优必定出现在“有限个临界点”，因此“枚举临界点”比写封闭式解析解更安全可靠、可维护性更高且更易扩展到多物流商。

# Ozon 定价：销量-价格模型与总利润优化（设计稿）

本文描述在现有“最优售价（单件利润最大化）”能力之上，如何引入销量-价格关系 q(P)，以最大化周期总利润 π(P)=q(P)×U(P)。本设计先文档化，确认后再开发。

---

## 1. 目标
- 给定：重量/尺寸/进货价/费率参数/可选物流与档位/汇率
- 现状：已能计算单件利润 U(P)（分段线性，跨组阶跃）并枚举临界点求最优
- 新增：引入销量函数 q(P)，优化总利润 π(P)=q(P)×U(P)

---

## 2. 候选销量模型

- 常数弹性（建议首版采用）
  - 假设：q(P) = κ × (P/P0)^(-ε)，ε>1
  - 解析内点（同一“组 + 尾城段”内，U(P)=m·P+b'）：
    P* = ε·b' / [(1−ε)·m]
  - 实现：把每个段的 P* 加入“临界点集合”，与 {1499,1500,1501,6999,7000,7001,750,10000}、区间端点一起评估；取 π 最大。
  - 参数：ε（默认 1.8，可 [1.2,3.0]）、参考价 P0（默认当期价格或竞品价，用于归一化）

- 逻辑斯蒂（饱和）
  - q(P) = Qmax / (1 + exp(k·(P − Pmid)))
  - 参数友好化：用两点法输入（P10→90%Qmax、P90→10%Qmax）反解 k,Pmid；Qmax 可设目标或估计
  - 实现：直接枚举候选价集计算 π(P)

- 自定义表格（CSV 导入）
  - 用户提供 (price, qty) 点列，做单调插值得到 q(P)
  - 实现：直接枚举候选价集计算 π(P)

- 鲁棒优化（建议与任一模型搭配）
  - 对 ε 或 (Qmax,k,Pmid) 给区间，做敏感性：
    - 最大期望：对参数分布抽样，最大化 E[π(P)]
    - 最大最小：最大化 min_scenario π(P)
    - 折衷解：在“期望最优±ΔRUB”内选“阈值安全带”内的点

---

## 3. 与现有系统的衔接

- 类型（`types/ozon.ts`）
  ```ts
  export type DemandModel =
    | { type: "none" }
    | { type: "constant_elasticity"; epsilon: number; pref_price?: number }
    | { type: "logistic"; qmax: number; p10: number; p90: number }
    | { type: "table"; points: Array<{ price: number; qty: number }> };

  // 在 OzonPricingParams 中新增
  demand?: DemandModel;
  period?: "day" | "week"; // 总利润口径
  ```

- 算法（`lib/ozon_pricing.ts`）
  - 维持“临界点 + 尾城拐点 + 区间端点”的集合
  - 常数弹性：在每个可行“组×尾城段”内计算解析 P* 并加入集合
  - 计算 U(P)（你现有实现）与 q(P)，求 π(P)=q×U，筛 Top-N

- UI（`app/ozon/page.tsx`）
  - 新增“销量模型”区域
    - None / 常数弹性 / 逻辑斯蒂 / 自定义表
    - 对应参数输入（ε 滑条；或两点法；或 CSV 上传）
  - 结果图表：价格-销量、价格-总利润；标注 1500/7000/750/10000 竖线
  - “鲁棒推荐”开关：展示最大期望/最大最小/折衷三种推荐

---

## 4. 默认值与建议
- 常数弹性：ε=1.8；鲁棒区间 [1.4, 2.4]
- 周期：按天
- 仍保留价格“安全区间 δ=10RUB”
- 同时保留“利润率上下限”约束（详见第 5 节）

---

## 5. 利润率约束（与现有实现结合）
- 下限：min_margin，默认 10%（可为负值）
- 上限：max_margin（可选，默认不启用或设 100%）
- 最终排序逻辑：
  1) 先过滤 margin≥min_margin 的集合
  2) 若设置 max_margin，则再过滤 margin≤max_margin 的集合
  3) 若过滤后为空，则回退到未过滤集合（并在 UI 提示）

---

## 6. 数据与学习（后续）
- 记录曝光/点击/下单，按 SPU/类目拟合 ε 或逻辑斯蒂参数，每 1~2 周滚动更新
- 在临界点附近做少量探索（A/B 或多臂赌博机）以减少局部最优风险

---

## 7. 里程碑（建议）
- M1 文档确认（本文件）
- M2 常数弹性 + 鲁棒优化实现（轻改 UI）
- M3 逻辑斯蒂 + 自定义表格 + 图表
- M4 数据采集与自动校准
